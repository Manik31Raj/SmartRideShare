<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Reset Password â€” SmartRideShare</title>

    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap"
          rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        body {
          background: linear-gradient(135deg, #ff6600, #ff9500);
          overflow: hidden;
          display: flex;
          justify-content: center;
          align-items: center;
          height: 100vh;
        }

        /* TRAFFIC LIGHT */
        .traffic-light {
          position: absolute;
          top: 60px;
          right: 80px;
          width: 60px; height: 165px;
          background: #222; border-radius: 15px;
          display: flex; flex-direction: column;
          padding: 12px;
          justify-content: space-between;
        }
        .light { width: 40px; height: 40px; border-radius: 50%; background: #444; }
        .on { animation: pulse 1s infinite ease-in-out; }
        @keyframes pulse { 0% { box-shadow: 0 0 5px currentColor; } 50% { box-shadow: 0 0 18px currentColor; } 100% { box-shadow: 0 0 8px currentColor; } }
        .green { background: limegreen; color: limegreen; }

        /* ROAD + CARS */
        .road { position: absolute; bottom: 0; width: 100%; height: 140px; background: #2f2f2f; }
        .road::before {
          content: "";
          position: absolute; top: 65px; width: 100%; height: 10px;
          background: repeating-linear-gradient(to right, #fff 0px 50px, transparent 50px 100px);
          animation: moveRoad 2s linear infinite;
        }
        @keyframes moveRoad { from { transform: translateX(0); } to { transform: translateX(-100px); } }
        .car { position: absolute; bottom: 120px; width: 180px; animation: carRun 10s linear infinite; }
        .car2 { width: 140px; left: -300px; animation-duration: 8s; }
        .car3 { width: 160px; left: -500px; animation-duration: 11s; }
        @keyframes carRun { 0% { transform: translateX(-200px); } 50% { transform: translateX(120vw); } 100% { transform: translateX(-200px); } }

        /* RESET BOX */
        .box {
          width: 380px;
          padding: 30px;
          border-radius: 12px;
          background: rgba(255,255,255,0.95);
          box-shadow: 0 8px 25px rgba(0,0,0,0.25);
          text-align: center;
          animation: float 3s ease-in-out infinite;
        }
        @keyframes float { 0%,100% { transform: translateY(0); } 50% { transform: translateY(-8px); } }
        h2 { color: #ff6600; margin-bottom: 20px; font-weight: 700; }
        input { width: 100%; padding: 12px; margin: 7px 0; border: 1px solid #ccc; border-radius: 6px; font-size: 0.95rem; }
        button {
          width: 100%; padding: 13px; border-radius: 30px; background: #ff6600; color: white;
          cursor: pointer; border: none; font-weight: 600; margin-top: 10px;
        }
        button[disabled] { opacity: 0.7; cursor: default; transform: none; }
        button:hover { background: #ff9300; transform: scale(1.05); transition: 0.2s; }

        /* PASSWORD EYE */
        .password-wrapper { position: relative; }
        .eye-icon {
          position: absolute; right: 15px; top: 50%;
          transform: translateY(-50%);
          cursor: pointer;
          color: #777; transition: 0.2s;
          outline: none;
        }
        .eye-icon:hover { color: #ff6600; transform: translateY(-50%) scale(1.15); }

        /* Eye animations */
        .eye-shake { animation: shake 0.2s ease; }
        @keyframes shake { 0% { transform: translateY(-50%) translateX(0); } 25% { transform: translateY(-50%) translateX(-3px); } 50% { transform: translateY(-50%) translateX(3px); } 75% { transform: translateY(-50%) translateX(-2px); } 100% { transform: translateY(-50%) translateX(0); } }
        .eye-blink { animation: blink 0.25s ease; }
        @keyframes blink { 0% { transform: translateY(-50%) scaleY(1); } 50% { transform: translateY(-50%) scaleY(0.1); } 100% { transform: translateY(-50%) scaleY(1); } }

        /* Strength Bar */
        #password-strength { width: 100%; height: 6px; background: #ddd; border-radius: 5px; margin-top: 4px; overflow: hidden; }
        #strength-bar { height: 100%; width: 0%; transition: 0.4s; }
        #strength-text { font-size: 0.75rem; margin-top: 3px; text-align: left; color: #444; min-height: 18px; }

        /* Message area for inline errors */
        #message { margin-top: 8px; font-size: 0.9rem; min-height: 20px; text-align: left; color: #222; }
        #message.error { color: #b71c1c; }
        #message.warning { color: #ff6b35; }

        .back-link { margin-top: 12px; }
        .back-link a { color: #444; text-decoration: none; }

        .btn-spinner { display:inline-block; width:16px; height:16px; border:2px solid rgba(255,255,255,0.6); border-top-color: white; border-radius:50%; margin-left:8px; vertical-align:middle; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .eye-icon[tabindex] { caret-color: transparent; }
    </style>
</head>

<body>

<!-- TRAFFIC LIGHT -->
<div class="traffic-light" aria-hidden="true">
    <div id="light-red" class="light"></div>
    <div id="light-yellow" class="light"></div>
    <div id="light-green" class="light green on"></div>
</div>

<!-- CARS -->
<img src="assets/car1.png" class="car" alt="car">
<img src="assets/car2.png" class="car car2" alt="car">
<img src="assets/car3.png" class="car car3" alt="car">
<div class="road" aria-hidden="true"></div>

<!-- RESET UI -->
<div class="box" role="main" aria-labelledby="title">
    <h2 id="title">Reset Password</h2>

    <!-- Hidden fields to store username/role as requested -->
    <input type="hidden" id="resetUsername" name="resetUsername" value="">
    <input type="hidden" id="resetRole" name="resetRole" value="">

    <form id="resetForm" autocomplete="off" novalidate>

        <!-- OLD PASSWORD -->
        <div class="password-wrapper">
            <input type="password" id="oldPassword" placeholder="Old Password" required autocomplete="current-password" aria-label="Old password">
            <i id="toggleOld" class="fa-solid fa-eye eye-icon" role="button" tabindex="0" aria-label="Toggle old password visibility"></i>
        </div>

        <!-- NEW PASSWORD -->
        <div class="password-wrapper">
            <input type="password" id="newPassword" placeholder="New Password" required autocomplete="new-password" aria-describedby="strength-text" aria-label="New password">
            <i id="toggleNew" class="fa-solid fa-eye eye-icon" role="button" tabindex="0" aria-label="Toggle new password visibility"></i>
        </div>

        <!-- Strength meter -->
        <div id="password-strength" aria-hidden="false">
            <div id="strength-bar" role="presentation"></div>
        </div>
        <div id="strength-text" aria-live="polite"></div>

        <!-- CONFIRM PASSWORD -->
        <div class="password-wrapper">
            <input type="password" id="confirmPassword" placeholder="Confirm Password" required autocomplete="new-password" aria-label="Confirm new password">
            <i id="toggleConfirm" class="fa-solid fa-eye eye-icon" role="button" tabindex="0" aria-label="Toggle confirm password visibility"></i>
        </div>

        <button id="submitBtn" type="submit">Update Password</button>
    </form>

    <div id="message" role="status" aria-live="polite"></div>

    <div class="back-link">
        <a href="login.html"><i class="fa-solid fa-arrow-left"></i> Back to Login</a>
    </div>
</div>

<script>
    /* Use DOMContentLoaded as in your previous logic */
    document.addEventListener("DOMContentLoaded", () => {

      const resetForm = document.getElementById("resetForm");
      const messageDiv = document.getElementById("message");
      const submitBtn = document.getElementById("submitBtn");

      // --- 1. Get username and role from the URL (or fallback to sessionStorage) ---
      const params = new URLSearchParams(window.location.search);
      let username = params.get("username");
      let role = params.get("role");

      // fallback to sessionStorage.smartRideUser if query params missing
      try {
        if ((!username || !role) && sessionStorage.getItem("smartRideUser")) {
          const stored = JSON.parse(sessionStorage.getItem("smartRideUser"));
          if (!username && stored.username) username = stored.username;
          if (!role && stored.role) role = stored.role;
        }
      } catch (e) {
        // ignore parse errors
        console.warn("sessionStorage parse error", e);
      }

      // Set hidden fields with data for easy access later
      document.getElementById("resetUsername").value = username || "";
      document.getElementById("resetRole").value = role || "";

      // helper to set traffic light state
      function setTrafficLight(color) {
        const red = document.getElementById("light-red");
        const yellow = document.getElementById("light-yellow");
        const green = document.getElementById("light-green");
        [red, yellow, green].forEach(l => l.classList.remove("on"));
        if (color === "red") red.classList.add("on");
        else if (color === "yellow") yellow.classList.add("on");
        else if (color === "green") green.classList.add("on");
      }

      // Check if critical data is missing
      if (!username || !role) {
        messageDiv.className = "error";
        messageDiv.textContent = "Error: User information missing. Please return to the login page.";
        resetForm.style.display = "none";
        setTrafficLight("red");
        return;
      }

      /* Eye toggles (keyboard accessible) */
      function attachEyeToggle(inputId, iconId) {
        const input = document.getElementById(inputId);
        const icon = document.getElementById(iconId);

        function toggle() {
          icon.classList.add("eye-shake", "eye-blink");
          setTimeout(() => icon.classList.remove("eye-shake"), 200);
          setTimeout(() => icon.classList.remove("eye-blink"), 250);

          if (input.type === "password") {
            input.type = "text";
            icon.classList.remove("fa-eye");
            icon.classList.add("fa-eye-slash");
          } else {
            input.type = "password";
            icon.classList.remove("fa-eye-slash");
            icon.classList.add("fa-eye");
          }
        }

        icon.addEventListener("click", toggle);
        icon.addEventListener("keydown", (e) => {
          if (e.key === "Enter" || e.key === " " || e.key === "Spacebar") {
            e.preventDefault();
            toggle();
          }
        });
      }

      attachEyeToggle("oldPassword", "toggleOld");
      attachEyeToggle("newPassword", "toggleNew");
      attachEyeToggle("confirmPassword", "toggleConfirm");

      /* Password strength meter (basic scoring) */
      const newPassEl = document.getElementById("newPassword");
      const bar = document.getElementById("strength-bar");
      const txt = document.getElementById("strength-text");

      newPassEl.addEventListener("input", function () {
        const val = this.value || "";
        let score = 0;
        if (val.length >= 6) score++;
        if (val.length >= 10) score++;
        if (/[A-Z]/.test(val)) score++;
        if (/[0-9]/.test(val)) score++;
        if (/[^A-Za-z0-9]/.test(val)) score++;

        const colors = ["#e74c3c", "#ff6b35", "#f39c12", "#f2c600", "#74d66a", "#2ecc71"];
        const labels = ["", "Very Weak", "Weak", "Okay", "Good", "Very Strong"];

        bar.style.width = (score * 20) + "%";
        bar.style.background = colors[score] || "#ddd";
        txt.textContent = labels[score] || "";
      });

      // --- 2. Handle the reset form submission (merged logic) ---
      resetForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        messageDiv.textContent = "";
        messageDiv.className = "";

        const oldPassword = document.getElementById("oldPassword").value;
        const newPassword = document.getElementById("newPassword").value;
        const confirmPassword = document.getElementById("confirmPassword").value;

        // Client-side validation
        if (newPassword !== confirmPassword) {
          messageDiv.textContent = "New passwords do not match!";
          messageDiv.className = "error";
          setTrafficLight("red");
          return;
        }

        if (!oldPassword) {
          messageDiv.textContent = "Please enter your old password.";
          messageDiv.className = "warning";
          setTrafficLight("yellow");
          return;
        }

        if (!newPassword || newPassword.length < 6) {
          messageDiv.textContent = "New password must be at least 6 characters.";
          messageDiv.className = "warning";
          setTrafficLight("yellow");
          return;
        }

        // API
        const resetApiUrl = "/v1/auth/reset-password";
        const resetData = {
          username: username,
          oldPassword: oldPassword,
          newPassword: newPassword,
          role: role
        };

        // disable UI & show spinner
        submitBtn.disabled = true;
        const origText = submitBtn.textContent;
        submitBtn.innerHTML = 'Updating... <span class="btn-spinner" aria-hidden="true"></span>';

        // AbortController timeout
        const controller = new AbortController();
        const timeout = setTimeout(() => controller.abort(), 10000); // 10s

        try {
          const response = await fetch(resetApiUrl, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(resetData),
            signal: controller.signal
          });

          clearTimeout(timeout);

          let data = null;
          try {
            data = await response.json();
          } catch (parseErr) {
            data = { status: response.ok ? "OK" : "ERROR", message: "Unexpected server response" };
          }

          // Accept multiple success tokens (matches your backend names)
          const okStatuses = new Set(["PASSWORD_RESET_SUCCESS", "PASSWORD_UPDATED", "SUCCESS", "OK"]);
          if (response.ok && okStatuses.has(data.status)) {
            setTrafficLight("green");

            // Your requested SweetAlert success popup with draggable = true
            Swal.fire({
              title: "Password Updated!",
              text: "You can now log in with your new password.",
              icon: "success",
              draggable: true,
              confirmButtonText: "Go to Login"
            }).then(() => {
              // redirect to login page as you requested
              window.location.href = "/login.html";
            });

          } else {
            // Show inline error using server status/message if present
            const serverMsg = data.message || data.status || "Failed to reset password. Please ensure your old password is correct.";
            messageDiv.textContent = `Error: ${serverMsg}`;
            messageDiv.className = "error";
            setTrafficLight("red");
          }

        } catch (err) {
          clearTimeout(timeout);
          console.error("Reset password error:", err);
          if (err.name === "AbortError") {
            messageDiv.textContent = "Server timeout. Please try again.";
          } else {
            messageDiv.textContent = "A network error occurred. Please try again later.";
          }
          messageDiv.className = "error";
          setTrafficLight("red");
        } finally {
          submitBtn.disabled = false;
          submitBtn.textContent = origText;
        }
      });

    });
</script>

</body>
</html>
