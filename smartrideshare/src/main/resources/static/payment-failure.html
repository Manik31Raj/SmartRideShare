<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Payment Failed — SmartRideShare</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        :root {
          --accent:#ff6600;
          --accent-light:#ff8d33;
          --danger:#d72323;
          --panel-bg:#ffffff;
          --muted:#6d6d72;
          --bg-grad: linear-gradient(135deg,#ff6600,#ff9500);
        }

        * { box-sizing:border-box; font-family:'Poppins',sans-serif; }

        html,body{
          margin:0; height:100%;
          background:var(--bg-grad);
          display:flex; justify-content:center; align-items:center;
        }

        .card {
          width:95%;
          max-width:1100px;
          background:white;
          padding:50px;
          border-radius:20px;
          box-shadow:0 20px 60px rgba(0,0,0,0.15);
          animation:slideIn .6s cubic-bezier(.2,.9,.2,1);
        }

        @keyframes slideIn { from { opacity:0; transform:translateY(30px) } to { opacity:1; transform:translateY(0) } }

        .content {
          display:grid;
          grid-template-columns:1fr 1fr;
          gap:40px;
          align-items:center;
        }

        .icon-wrap {
          width:160px; height:160px;
          border-radius:50%;
          background:linear-gradient(135deg,#ff3b3b,#ff6b6b);
          display:flex; justify-content:center; align-items:center;
          font-size:70px;
          color:white;
          margin:0 auto 20px;
          box-shadow:0 10px 30px rgba(255,80,80,0.25);
          animation:iconDrop .6s ease;
        }

        @keyframes iconDrop {
          0% { transform:scale(.5) translateY(-20px); opacity:0; }
          60% { transform:scale(1.1) translateY(5px); opacity:1; }
          100% { transform:scale(1) translateY(0); }
        }

        h1{ text-align:center; margin:0; font-size:2rem; color:#c70000; }
        p{ color:var(--muted); text-align:center; }

        .meta { margin-top:20px; display:flex; flex-direction:column; gap:12px; }
        .lbl { font-weight:700; color:#333; }
        .value { font-weight:800; font-size:1.3rem; color:#c70000; }

        .btns { margin-top:30px; display:flex; gap:16px; }
        .btn {
          width:100%; padding:12px 20px; border-radius:10px; font-weight:700; border:none; cursor:pointer; font-size:1rem; display:flex; align-items:center; justify-content:center; gap:8px;
        }
        .btn-primary { background:#ff6600; color:white; }
        .btn-danger { background:#d72323; color:white; }
        .btn-outline { background:white; border:1px solid #ddd; }

        @media(max-width:760px){ .content{ grid-template-columns:1fr; text-align:center; } .btns{ flex-direction:column; } }
    </style>
</head>

<body>
<div class="card">
    <div class="content">

        <div style="text-align:center;">
            <div class="icon-wrap"><i class="fa-solid fa-xmark"></i></div>
            <h1>Payment Failed</h1>
            <p>Your payment could not be completed.</p>
            <p>Please try again or use a different payment method.</p>
        </div>

        <div>
            <h2 style="margin:0 0 10px; color:#333;">Payment Details</h2>

            <div class="meta">
                <div>
                    <div class="lbl">Booking ID</div>
                    <div id="bookingId" class="value">—</div>
                </div>
                <div>
                    <div class="lbl">Amount</div>
                    <div id="amount" class="value">—</div>
                </div>
            </div>

            <div class="btns" style="margin-top:26px;">
                <button class="btn btn-primary" id="backBtn">
                    <i class="fa-solid fa-arrow-left"></i> Back to Dashboard
                </button>

                <button class="btn btn-danger" id="retryBtn">
                    <i class="fa-solid fa-rotate-right"></i> Retry Payment
                </button>
            </div>
        </div>

    </div>
</div>

<script>
    const qs = s => document.querySelector(s);
    const params = new URLSearchParams(location.search || '');
    const bookingId = params.get("bookingId") || '';
    const amount = params.get("amount") || '';

    // Get User from session to send to backend
    const userSession = JSON.parse(sessionStorage.getItem('smartRideUser') || '{}');
    const username = params.get('username') || userSession.username || userSession.email || '';

    qs("#bookingId").textContent = bookingId || "—";
    qs("#amount").textContent = amount ? `₹ ${amount}` : "—";

    /* Backend PATCH for payment-failure (FIXED) */
    async function patchPaymentFailure() {
      if (!bookingId) return;
      if (!username) {
          console.warn("Payment Failed Page: Username missing, cannot update status.");
          return;
      }

      try {
        // FIXED: Using Query Parameter ?passengerUsername=... to match @RequestParam in backend
        await fetch(`/v1/passenger/payment-failure/${encodeURIComponent(bookingId)}?passengerUsername=${encodeURIComponent(username)}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' }
        });
        console.log("Payment failure status updated in backend.");
      } catch (err) {
        console.error('patchPaymentFailure error', err);
      }
    }

    /* Auto-call on load */
    window.addEventListener('load', () => {
      // call the PATCH endpoint immediately
      patchPaymentFailure();
    });

    /* Back to dashboard */
    qs("#backBtn").addEventListener("click", () => {
      window.location.href = "/passenger-dashboard.html#mybookings";
    });

    /* Retry (Redirects to dashboard so they can click Pay again) */
    qs("#retryBtn").addEventListener("click", () => {
      Swal.fire({
        title:"Retry Payment?",
        text:"You will be redirected back to your bookings to retry the payment.",
        icon:"question",
        showCancelButton:true,
        confirmButtonText:"Yes, Retry"
      }).then(r=>{
        if(!r.isConfirmed) return;
        window.location.href = "/passenger-dashboard.html#mybookings";
      });
    });
</script>
</body>
</html>