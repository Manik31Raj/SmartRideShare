<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Admin Dashboard — SmartRideShare</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        :root{
          --accent:#ff6600;
          --accent-2:#ff8f33;
          --bg-grad: linear-gradient(135deg,#ff6600,#ff9500);
          --panel-bg: rgba(255,255,255,0.95);
          --text:#222;
          --sidebar-width:260px;
          --card-radius:12px;
          --muted:#6d6d72;
        }
        *{box-sizing:border-box;font-family:'Poppins',sans-serif}
        html,body{height:100%;margin:0;background:var(--bg-grad);color:var(--text);}
        .app{min-height:100vh;display:grid;grid-template-columns:var(--sidebar-width) 1fr;gap:20px;padding:20px;align-items:start}
        .sidebar{position:sticky;top:20px;height:calc(100vh - 40px);padding:16px;border-radius:var(--card-radius);background:var(--panel-bg);box-shadow:0 8px 30px rgba(0,0,0,0.12);display:flex;flex-direction:column;gap:12px;overflow:auto}
        .nav{display:flex;flex-direction:column;gap:6px}
        .nav a{display:flex;align-items:center;gap:12px;padding:10px 12px;border-radius:8px;color:#333;text-decoration:none;font-weight:600}
        .nav a .fa{width:20px;text-align:center;opacity:0.95}
        .nav a:hover{background:#fff7f0;color:var(--accent);transform:translateX(4px);transition:0.12s}
        .nav a.active{background:linear-gradient(90deg, rgba(255,102,0,0.12), rgba(255,148,0,0.08));color:var(--accent);box-shadow:inset 0 0 0 1px rgba(255,102,0,0.06)}
        .meta{margin-top:auto;border-top:1px dashed rgba(0,0,0,0.06);padding-top:10px;display:flex;flex-direction:column;gap:6px}
        .main{background:linear-gradient(180deg, rgba(255,255,255,0.92), rgba(255,255,255,0.98));border-radius:var(--card-radius);padding:20px;box-shadow:0 8px 30px rgba(0,0,0,0.12);min-height:calc(100vh-40px);overflow:auto}
        .main-header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:18px}
        .brand{display:flex;align-items:center;gap:12px}
        .logo{width:44px;height:44px;border-radius:10px;background:var(--accent);display:flex;align-items:center;justify-content:center;color:white;font-weight:700;font-size:1rem;box-shadow:0 6px 12px rgba(0,0,0,0.12)}
        h1{font-size:1.1rem;margin:0}
        .small-muted{color:var(--muted);font-size:0.9rem}
        .card{background:#fff;padding:12px;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,0.06);margin-bottom:12px}
        .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin-bottom:14px}
        table{width:100%;border-collapse:collapse}
        th,td{text-align:left;padding:10px 8px;border-bottom:1px solid #f3f3f3;font-size:0.95rem}
        th{color:#666;font-weight:700;font-size:0.82rem;text-transform:uppercase;letter-spacing:0.6px}
        .pill{background:#fff7f0;color:var(--accent);display:inline-block;padding:6px 8px;border-radius:999px;font-weight:700;font-size:0.85rem}
        .btn-sm{padding:8px 10px;border-radius:8px;background:var(--accent);color:white;border:none;cursor:pointer;font-weight:700}
        .btn-outline { padding:8px 10px;border-radius:8px;background:#fff;border:1px solid #e6e6e6;color:#333;cursor:pointer }
        .spinner{display:inline-block;width:12px;height:12px;border:2px solid rgba(0,0,0,0.12);border-top-color: rgba(0,0,0,0.6);border-radius:50%;margin-left:8px;animation:spin .7s linear infinite;vertical-align:middle}
        @keyframes spin{to{transform:rotate(360deg)}}
        .pagination{display:flex;gap:6px;align-items:center;justify-content:center;margin-top:10px;flex-wrap:wrap}
        .page-btn{padding:6px 8px;border-radius:6px;border:1px solid #eee;cursor:pointer;background:#fff}
        .page-btn.active{background:var(--accent);color:white;border-color:var(--accent)}
        .page-btn[disabled]{opacity:0.6;cursor:not-allowed}
        @media (max-width:900px){.app{grid-template-columns:1fr;padding:12px}.sidebar{position:relative;order:2;height:auto;top:auto}.main{order:1;min-height:auto}}
        .muted{color:var(--muted)}
        .right{text-align:right}
        .center{text-align:center}
        .danger{background:#ff3b30;color:white;border:none;padding:6px 8px;border-radius:6px;cursor:pointer}
        .search-row{display:flex;gap:8px;align-items:center;margin-bottom:8px}
        .search-row input{padding:8px;border-radius:6px;border:1px solid #eaeaea;flex:1}
        .search-row select{padding:8px;border-radius:6px;border:1px solid #eaeaea;background:#fff}
        .small-input{width:72px;padding:6px;border-radius:6px;border:1px solid #eaeaea}
        /* Compact drawer (card-like) */
        .drawer-backdrop { position:fixed; inset:0; background:rgba(0,0,0,0.20); z-index:999; display:none; }
        .drawer { position:fixed; top:12vh; right:-380px; width:340px; height:auto; max-height:76vh; background:#fff; border-radius:12px; box-shadow:0 18px 40px rgba(0,0,0,0.2); z-index:1000; padding:16px; overflow:auto; transition:right 250ms cubic-bezier(.2,.9,.2,1); }
        .drawer.open { right:20px; }
        .drawer .header { display:flex; gap:12px; align-items:center; justify-content:space-between; }
        .drawer .avatar { width:56px; height:56px; border-radius:10px; background:linear-gradient(135deg,#f6f6f6,#fff); display:inline-flex;align-items:center;justify-content:center;color:#666;font-weight:800;font-size:1rem;box-shadow:0 6px 18px rgba(0,0,0,0.06); overflow:hidden }
        .drawer .meta { color:var(--muted); font-size:0.9rem; }
        .drawer .section { margin-top:12px; padding-top:8px; border-top:1px dashed #f3f3f3; }
        .drawer .kv { display:flex; justify-content:space-between; gap:8px; padding:6px 0; border-bottom:1px solid rgba(0,0,0,0.03); }
        .drawer .kv .k { color:var(--muted); font-size:0.82rem; }
        .drawer .kv .v { font-weight:700; }
        .drawer .badge { display:inline-block; padding:6px 8px; border-radius:999px; font-weight:700; font-size:0.8rem; color:white; background:var(--accent-2); }
        .drawer .actions { display:flex; gap:8px; margin-top:12px; justify-content:space-between; }
        .drawer .muted { color:var(--muted); font-size:0.92rem; }
        .drawer .small-link { color:var(--accent); text-decoration:none; font-weight:700; font-size:0.9rem; }
        /* small responsive */
        @media (max-width:480px) {
          .drawer { width:92vw; right:-92vw; border-radius:10px; top:8vh; max-height:84vh; }
          .drawer.open { right:4vw; }
        }
    </style>
</head>
<body>
<div class="app" id="appRoot">
    <aside class="sidebar" aria-label="Admin navigation">
        <nav class="nav" id="leftNav">
            <a href="#overview" data-view="overview" class="nav-link active"><i class="fa-solid fa-chart-line"></i>Overview</a>
            <a href="#admins" data-view="admins" class="nav-link"><i class="fa-solid fa-user-shield"></i>Admins</a>
            <a href="#drivers" data-view="drivers" class="nav-link"><i class="fa-solid fa-car"></i>Drivers</a>
            <a href="#passengers" data-view="passengers" class="nav-link"><i class="fa-solid fa-user"></i>Passengers</a>
            <a href="#rides" data-view="rides" class="nav-link"><i class="fa-solid fa-route"></i>Rides</a>
            <a href="#bookings" data-view="bookings" class="nav-link"><i class="fa-solid fa-book"></i>Bookings</a>
            <a href="#settings" data-view="settings" class="nav-link"><i class="fa-solid fa-gear"></i>Settings</a>
            <a href="#" id="resetPasswordBtn" class="nav-link"><i class="fa-solid fa-key"></i>Reset Password</a>
        </nav>
        <div class="meta">
            <div class="small">Environment: <span class="pill">Admin</span></div>
            <div class="small">Version: <strong>v1.0</strong></div>
        </div>
    </aside>

    <main class="main" id="mainContent" role="main" aria-live="polite">
        <div class="main-header">
            <div class="brand">
                <div class="logo">SR</div>
                <div>
                    <h1>SmartRideShare — Admin</h1>
                    <div class="small-muted" id="mainSubtitle">Overview</div>
                </div>
            </div>

            <div style="display:flex;align-items:center;gap:10px;">
                <div id="showUsername" class="small-muted">—</div>
                <button id="logoutButton" class="btn-sm" title="Sign out"><i class="fa-solid fa-right-from-bracket"></i>&nbsp;Logout</button>
            </div>
        </div>

        <section id="viewArea"></section>
    </main>
</div>

<script>
    // Admin dashboard with compact drawer populated from DriverResponse / PassengerResponse fields
    document.addEventListener("DOMContentLoaded", () => {

      const params = new URLSearchParams(window.location.search);
      let username = params.get("username");
      let role = params.get("role");
      try {
        if ((!username || !role) && sessionStorage.getItem("smartRideUser")) {
          const stored = JSON.parse(sessionStorage.getItem("smartRideUser"));
          if (!username && stored.username) username = stored.username;
          if (!role && stored.role) role = stored.role;
        }
      } catch (e) { console.warn("session parse error", e); }

      document.getElementById("showUsername").textContent = (username || "ADMIN").toUpperCase();

      const viewArea = document.getElementById("viewArea");
      const navLinks = document.querySelectorAll(".nav-link");
      const resetPasswordBtn = document.getElementById("resetPasswordBtn");
      const logoutButton = document.getElementById("logoutButton");
      const mainSubtitle = document.getElementById("mainSubtitle");

      async function apiFetch(path, opts = {}, timeout = 15000) {
        const controller = new AbortController();
        const id = setTimeout(() => controller.abort(), timeout);
        const headers = Object.assign({ "Content-Type": "application/json" }, opts.headers || {});
        try {
          const res = await fetch(path, Object.assign({}, opts, { headers, signal: controller.signal }));
          clearTimeout(id);
          const txt = await res.text().catch(()=>null);
          if (!res.ok) {
            let payload = null;
            try { payload = txt ? JSON.parse(txt) : null } catch(e){ payload = txt; }
            const err = new Error("HTTP " + res.status);
            err.status = res.status;
            err.payload = payload;
            throw err;
          }
          if (!txt) return null;
          try { return JSON.parse(txt); } catch(e){ return txt; }
        } catch (err) {
          clearTimeout(id);
          throw err;
        }
      }

      function setSubtitle(s) { mainSubtitle.textContent = s || ""; }
      function formatDate(dt) { if (!dt) return "N/A"; try { return new Date(dt).toLocaleString(); } catch { return dt; } }
      function clamp(v, a, b) { return Math.max(a, Math.min(b, v)); }

      function getLimitFor(view) { const v = localStorage.getItem(`sr_limit_${view}`); return v ? Number(v) : 10; }
      function setLimitFor(view, limit) { localStorage.setItem(`sr_limit_${view}`, String(limit)); }

      function createTableSkeleton(cols, idPrefix="tbl") {
        const container = document.createElement("div");
        container.className = "card";
        const table = document.createElement("table");
        table.className = idPrefix + "-table";
        const thead = document.createElement("thead");
        const tr = document.createElement("tr");
        cols.forEach(c => { const th = document.createElement("th"); th.textContent = c; tr.appendChild(th); });
        thead.appendChild(tr);
        const tbody = document.createElement("tbody"); tbody.id = idPrefix + "-tbody";
        table.appendChild(thead); table.appendChild(tbody); container.appendChild(table);
        return { container, tbody };
      }
      function loadingRow(tbody, colspan=4) { tbody.innerHTML = ""; const tr = document.createElement("tr"); const td = document.createElement("td"); td.colSpan=colspan; td.className="center muted"; td.textContent="Loading..."; tr.appendChild(td); tbody.appendChild(tr); }
      function emptyRow(tbody, msg="No records", colspan=4) { tbody.innerHTML=""; const tr=document.createElement("tr"); const td=document.createElement("td"); td.colSpan=colspan; td.className="center muted"; td.textContent = msg; tr.appendChild(td); tbody.appendChild(tr); }

      const store = {
        admins: { all: [], filtered: [], page:1, limit: getLimitFor("admins"), q:"" },
        drivers: { all: [], filtered: [], page:1, limit: getLimitFor("drivers"), q:"" },
        passengers: { all: [], filtered: [], page:1, limit: getLimitFor("passengers"), q:"" },
        rides: { all: [], filtered: [], page:1, limit: getLimitFor("rides"), q:"" },
        bookings: { all: [], filtered: [], page:1, limit: getLimitFor("bookings"), q:"" }
      };

      const pendingDeletes = new Map();

      function applyFilterAndReset(viewKey) {
        const s = store[viewKey];
        const q = (s.q || "").trim().toLowerCase();
        if (!q) s.filtered = s.all.slice();
        else s.filtered = s.all.filter(item => {
          const text = JSON.stringify(item).toLowerCase();
          return text.includes(q);
        });
        s.page = 1;
      }

      function pageSlice(viewKey) {
        const s = store[viewKey];
        const limit = s.limit || 10;
        const total = s.filtered.length;
        const totalPages = Math.max(1, Math.ceil(total / limit));
        s.page = clamp(s.page, 1, totalPages);
        const start = (s.page - 1) * limit;
        const end = start + limit;
        const pageItems = s.filtered.slice(start, end);
        return { items: pageItems, total, totalPages, page: s.page, limit };
      }

      function renderPager(container, viewKey, onPageSelected) {
        container.innerHTML = "";
        const { total, totalPages, page } = pageSlice(viewKey);
        if (totalPages <= 1) return;
        const prev = document.createElement("button"); prev.className="page-btn"; prev.textContent="Prev"; prev.disabled = page<=1;
        prev.addEventListener("click", ()=> { store[viewKey].page = Math.max(1, page-1); onPageSelected(); });
        container.appendChild(prev);

        const start = Math.max(1, page - 2);
        const end = Math.min(totalPages, page + 2);
        if (start > 1) {
          const b1 = document.createElement("button"); b1.className="page-btn"; b1.textContent="1"; b1.addEventListener("click", ()=> { store[viewKey].page = 1; onPageSelected(); }); container.appendChild(b1);
          if (start > 2) container.appendChild(document.createTextNode("..."));
        }
        for (let p = start; p <= end; p++) {
          const b = document.createElement("button"); b.className = "page-btn" + (p===page?" active":""); b.textContent = String(p);
          b.addEventListener("click", ()=> { store[viewKey].page = p; onPageSelected(); });
          container.appendChild(b);
        }
        if (end < totalPages - 1) container.appendChild(document.createTextNode("..."));
        if (end < totalPages) {
          const bl = document.createElement("button"); bl.className="page-btn"; bl.textContent=String(totalPages);
          bl.addEventListener("click", ()=> { store[viewKey].page = totalPages; onPageSelected(); });
          container.appendChild(bl);
        }

        const next = document.createElement("button"); next.className="page-btn"; next.textContent="Next"; next.disabled = page>=totalPages;
        next.addEventListener("click", ()=> { store[viewKey].page = Math.min(totalPages, page+1); onPageSelected(); });
        container.appendChild(next);

        const goWrap = document.createElement("span"); goWrap.style.display="inline-flex"; goWrap.style.gap="6px"; goWrap.style.marginLeft="12px"; goWrap.style.alignItems="center";
        const goInput = document.createElement("input"); goInput.type="number"; goInput.min="1"; goInput.placeholder="Page #"; goInput.className="small-input";
        const goBtn = document.createElement("button"); goBtn.className="btn-sm"; goBtn.textContent="Go";
        goBtn.addEventListener("click", ()=> {
          let p = Math.max(1, Number(goInput.value) || 1);
          p = Math.min(p, totalPages);
          store[viewKey].page = p;
          onPageSelected();
          goInput.value = "";
        });
        goInput.addEventListener("keydown", (ev)=> { if (ev.key === "Enter") goBtn.click(); });
        goWrap.appendChild(goInput); goWrap.appendChild(goBtn);
        container.appendChild(goWrap);
      }

      async function scheduleDeleteWithUndo({ viewKey, niceType, id, rowEl, deleteUrl, matchFn }) {
        if (!rowEl || !rowEl.parentElement) return;
        if (pendingDeletes.has(id)) { Swal.fire("Pending", `${niceType} deletion already pending`, "info"); return; }

        rowEl.remove();
        const s = store[viewKey];
        const removedIndex = s.all.findIndex(matchFn);
        let removedItem = null;
        if (removedIndex >= 0) removedItem = s.all.splice(removedIndex,1)[0];
        applyFilterAndReset(viewKey);

        const toastPromise = Swal.fire({
          toast: true, position: "top-end", showConfirmButton: true, icon: "info",
          title: `${niceType} removed (will delete on server in 6s)`, confirmButtonText: "Undo",
          timer: 6000, timerProgressBar: true
        });

        pendingDeletes.set(id, { canceled:false });

        const res = await toastPromise;
        if (res.isConfirmed) {
          pendingDeletes.get(id).canceled = true;
          if (removedItem) s.all.splice(removedIndex, 0, removedItem);
          applyFilterAndReset(viewKey);
          pendingDeletes.delete(id);
          Swal.fire({ toast:true, position:"top-end", icon:"success", title:"Undo: deletion canceled", timer:1200, showConfirmButton:false });
          return;
        }

        pendingDeletes.get(id).inFlight = true;
        try {
          const apiRes = await apiFetch(deleteUrl, { method: "DELETE" });
          Swal.fire({ toast:true, position:"top-end", icon:"success", title:`${niceType} deleted`, timer:1400, showConfirmButton:false });
        } catch (err) {
          if (removedItem) s.all.splice(removedIndex, 0, removedItem);
          applyFilterAndReset(viewKey);
          console.error("Delete error", err);
          Swal.fire("Error", "Server error while deleting. Row restored.", "error");
        } finally {
          pendingDeletes.delete(id);
        }
      }

      // Compact drawer (card)
      function createDrawer() {
        if (document.getElementById("sr-drawer")) return;
        const backdrop = document.createElement("div");
        backdrop.className = "drawer-backdrop";
        backdrop.id = "sr-drawer-backdrop";
        const drawer = document.createElement("aside");
        drawer.className = "drawer";
        drawer.id = "sr-drawer";

        drawer.innerHTML = `
          <div class="header">
            <div style="display:flex;gap:12px;align-items:center;">
              <div class="avatar" id="drawer-avatar" aria-hidden="true"></div>
              <div>
                <div id="drawer-name" style="font-weight:800;font-size:1rem">Name</div>
                <div id="drawer-username" class="meta">username</div>
              </div>
            </div>
            <div>
              <button id="drawer-close" aria-label="Close drawer" class="btn-outline">Close</button>
            </div>
          </div>

          <div class="section" id="drawer-basic">
            <div class="kv"><div class="k">Email</div><div class="v" id="drawer-email">—</div></div>
            <div class="kv"><div class="k">Contact</div><div class="v" id="drawer-contact">—</div></div>
            <div class="kv"><div class="k">Age</div><div class="v" id="drawer-age">—</div></div>
            <div class="kv"><div class="k">Role</div><div class="v" id="drawer-role">—</div></div>
          </div>

          <div class="section" id="drawer-extra"></div>

          <div class="actions">
            <button id="drawer-reset" class="btn-sm"><i class="fa-solid fa-key"></i>&nbsp;Reset</button>
            <button id="drawer-message" class="btn-outline"><i class="fa-solid fa-message"></i>&nbsp;Message</button>
          </div>
        `;

        document.body.appendChild(backdrop);
        document.body.appendChild(drawer);

        backdrop.addEventListener("click", closeDrawer);
        drawer.querySelector("#drawer-close").addEventListener("click", closeDrawer);
        document.addEventListener("keydown", (e) => { if (e.key === "Escape") closeDrawer(); });
      }

      // openDrawer returns a Promise
      function openDrawer({ role, id, cachedItem }) {
        createDrawer();
        const backdrop = document.getElementById("sr-drawer-backdrop");
        const drawer = document.getElementById("sr-drawer");
        backdrop.style.display = "block";
        setTimeout(()=> drawer.classList.add("open"), 10);

        populateDrawer(cachedItem || { id }, { immediate: true });

        drawer.setAttribute("tabindex", "-1");
        drawer.focus();

        const resetBtn = drawer.querySelector("#drawer-reset");
        resetBtn.onclick = () => {
          const q = new URLSearchParams({ username: cachedItem?.username || cachedItem?.email || "", role: (role || "").toUpperCase() });
          window.location.href = "reset-password.html?" + q.toString();
        };

        const msgBtn = drawer.querySelector("#drawer-message");
        msgBtn.onclick = () => {
          Swal.fire("Message", `Open messaging for ${cachedItem?.fullname || cachedItem?.username || id}`, "info");
        };

        return new Promise((resolve) => {
          const endpoint = role === "driver" ? `/v1/admin/driver/${id}` : `/v1/admin/passenger/${id}`;
          const extra = drawer.querySelector("#drawer-extra");
          extra.innerHTML = `<div class="muted">Loading details...</div>`;
          apiFetch(endpoint)
            .then(json => {
              const final = Object.assign({}, cachedItem || {}, json || {});
              populateDrawer(final, { immediate: false });
            })
            .catch(err => {
              console.warn("drawer fetch error", err);
              extra.innerHTML = `<div class="muted">Could not load full details. Showing cached info.</div>`;
            })
            .finally(() => resolve());
        });
      }

      function populateDrawer(item = {}, opts = {}) {
        const drawer = document.getElementById("sr-drawer");
        if (!drawer) return;
        const avatarEl = drawer.querySelector("#drawer-avatar");
        const nameEl = drawer.querySelector("#drawer-name");
        const usernameEl = drawer.querySelector("#drawer-username");
        const contactEl = drawer.querySelector("#drawer-contact");
        const emailEl = drawer.querySelector("#drawer-email");
        const ageEl = drawer.querySelector("#drawer-age");
        const roleEl = drawer.querySelector("#drawer-role");
        const extra = drawer.querySelector("#drawer-extra");

        if (item.avatarUrl) {
          avatarEl.innerHTML = `<img alt="${item.fullname || ''}" src="${item.avatarUrl}" style="width:100%;height:100%;object-fit:cover">`;
        } else {
          const initials = (item.fullname || item.username || "U").split(" ").map(s => s[0]).slice(0,2).join("").toUpperCase();
          avatarEl.textContent = initials;
        }

        nameEl.textContent = item.fullname || item.username || ("User " + (item.id || ""));
        usernameEl.textContent = item.username || item.email || "";

        emailEl.textContent = item.email || (item.username || "—");
        contactEl.textContent = item.contactNumber || "—";
        ageEl.textContent = item.age ?? "—";
        roleEl.textContent = item.role ? String(item.role).toUpperCase() : "—";

        // Extra section: for driver show license/vehicle; for passenger show stats/notes
        let html = "";
        if (item.licenseNumber || item.vehicleModel || item.vehiclePlate) {
          html += `<div style="font-weight:800;margin-bottom:6px;color:var(--muted)">Vehicle & License</div>`;
          if (item.licenseNumber) html += `<div class="kv"><div class="k">License</div><div class="v">${item.licenseNumber}</div></div>`;
          if (item.vehicleModel) html += `<div class="kv"><div class="k">Model</div><div class="v">${item.vehicleModel}</div></div>`;
          if (item.vehiclePlate) html += `<div class="kv"><div class="k">Plate</div><div class="v">${item.vehiclePlate}</div></div>`;
        }

        // small stats if present
        if (item.stats) {
          html += `<div style="margin-top:8px;font-weight:800;color:var(--muted)">Stats</div>`;
          if (typeof item.stats.totalRides !== "undefined") html += `<div class="kv"><div class="k">Total Rides</div><div class="v">${item.stats.totalRides}</div></div>`;
          if (typeof item.stats.totalBookings !== "undefined") html += `<div class="kv"><div class="k">Total Bookings</div><div class="v">${item.stats.totalBookings}</div></div>`;
          if (typeof item.stats.averageRating !== "undefined") html += `<div class="kv"><div class="k">Rating</div><div class="v">${item.stats.averageRating}</div></div>`;
        }

        // recent activity summary (if any)
        if (item.recentRides && item.recentRides.length) {
          const lines = item.recentRides.slice(0,3).map(rr => `<div class="kv"><div class="k" style="flex:1">${(rr.from||rr.startLocation||"") + " → " + (rr.to||rr.endLocation||"")}</div><div class="v">${rr.date ? new Date(rr.date).toLocaleDateString() : ""}</div></div>`).join("");
          html += `<div style="margin-top:8px;font-weight:800;color:var(--muted)">Recent Rides</div>` + lines;
        } else if (item.recentBookings && item.recentBookings.length) {
          const lines = item.recentBookings.slice(0,3).map(b => `<div class="kv"><div class="k">${(b.startLocation||"") + " → " + (b.endLocation||"")}</div><div class="v">${b.date ? new Date(b.date).toLocaleDateString() : ""}</div></div>`).join("");
          html += `<div style="margin-top:8px;font-weight:800;color:var(--muted)">Recent Bookings</div>` + lines;
        }

        extra.innerHTML = html || `<div class="muted">No extra details available.</div>`;
      }

      function closeDrawer() {
        const drawer = document.getElementById("sr-drawer");
        const backdrop = document.getElementById("sr-drawer-backdrop");
        if (drawer) {
          drawer.classList.remove("open");
          setTimeout(()=> {
            if (backdrop) backdrop.style.display = "none";
          }, 260);
        } else if (backdrop) backdrop.style.display = "none";
      }

      // Row renderers (view button shows spinner while detail GET is in flight)
      function adminRow(admin) {
        const tr = document.createElement("tr");
        const tdName = document.createElement("td"); tdName.textContent = admin.fullname || "(N/A)";
        const tdEmail = document.createElement("td"); tdEmail.textContent = admin.email || "(N/A)";
        const tdDept = document.createElement("td"); tdDept.textContent = admin.department || "-";
        const tdAct = document.createElement("td");
        const del = document.createElement("button"); del.className="danger"; del.textContent="Delete";
        del.addEventListener("click", async ()=> {
          const ok = await Swal.fire({ title:`Delete Admin`, text:`Delete ${admin.fullname}?`, icon:"warning", showCancelButton:true, confirmButtonText:"Yes, delete" });
          if (!ok.isConfirmed) return;
          scheduleDeleteWithUndo({
            viewKey: "admins",
            niceType: "Admin",
            id: String(admin.id),
            rowEl: tr,
            deleteUrl: `/v1/admin/${admin.id}`,
            matchFn: it => String(it.id) === String(admin.id)
          });
        });
        tdAct.appendChild(del);
        tr.appendChild(tdName); tr.appendChild(tdEmail); tr.appendChild(tdDept); tr.appendChild(tdAct);
        return tr;
      }

      function driverRow(d) {
        const tr = document.createElement("tr");
        const td1 = document.createElement("td"); td1.textContent = d.fullname || "(N/A)";
        const td2 = document.createElement("td"); td2.textContent = d.username || "(N/A)";
        const td3 = document.createElement("td"); td3.textContent = d.vehiclePlate || (d.vehiclePlate ?? "N/A");
        const td4 = document.createElement("td"); td4.textContent = formatDate(d.createdAt);
        const td5 = document.createElement("td");
        const viewBtn = document.createElement("button");
        viewBtn.className = "btn-outline";
        viewBtn.style.marginRight = "8px";
        viewBtn.innerHTML = `<i class="fa-solid fa-eye"></i> View`;
        viewBtn.addEventListener("click", (e) => {
          e.preventDefault();
          viewBtn.disabled = true;
          const spin = document.createElement("span");
          spin.className = "spinner";
          viewBtn.appendChild(spin);

          openDrawer({ role: "driver", id: d.id, cachedItem: d })
            .finally(() => {
              try { viewBtn.removeChild(spin); } catch (err) {}
              viewBtn.disabled = false;
            });
        });
        td5.appendChild(viewBtn);

        const del = document.createElement("button"); del.className="danger"; del.textContent="Delete";
        del.addEventListener("click", async ()=> {
          const ok = await Swal.fire({ title:`Delete Driver`, text:`Delete ${d.fullname}?`, icon:"warning", showCancelButton:true, confirmButtonText:"Yes, delete" });
          if (!ok.isConfirmed) return;
          scheduleDeleteWithUndo({
            viewKey: "drivers",
            niceType: "Driver",
            id: String(d.id),
            rowEl: tr,
            deleteUrl: `/v1/admin/delete-driver/${d.id}`,
            matchFn: it => String(it.id) === String(d.id)
          });
        });
        td5.appendChild(del);
        tr.appendChild(td1); tr.appendChild(td2); tr.appendChild(td3); tr.appendChild(td4); tr.appendChild(td5);
        return tr;
      }

      function passengerRow(p) {
        const tr = document.createElement("tr");
        const td1 = document.createElement("td"); td1.textContent = p.fullname || "(N/A)";
        const td2 = document.createElement("td"); td2.textContent = p.username || "(N/A)";
        const td3 = document.createElement("td"); td3.textContent = p.contactNumber || "N/A";
        const td4 = document.createElement("td"); td4.textContent = p.age ?? "N/A";
        const td5 = document.createElement("td");
        const viewBtn = document.createElement("button");
        viewBtn.className = "btn-outline";
        viewBtn.style.marginRight = "8px";
        viewBtn.innerHTML = `<i class="fa-solid fa-eye"></i> View`;
        viewBtn.addEventListener("click", (e) => {
          e.preventDefault();
          viewBtn.disabled = true;
          const spin = document.createElement("span");
          spin.className = "spinner";
          viewBtn.appendChild(spin);

          openDrawer({ role: "passenger", id: p.id, cachedItem: p })
            .finally(() => {
              try { viewBtn.removeChild(spin); } catch (err) {}
              viewBtn.disabled = false;
            });
        });
        td5.appendChild(viewBtn);

        const del = document.createElement("button"); del.className="danger"; del.textContent="Delete";
        del.addEventListener("click", async ()=> {
          const ok = await Swal.fire({ title:`Delete Passenger`, text:`Delete ${p.fullname}?`, icon:"warning", showCancelButton:true, confirmButtonText:"Yes, delete" });
          if (!ok.isConfirmed) return;
          scheduleDeleteWithUndo({
            viewKey: "passengers",
            niceType: "Passenger",
            id: String(p.id),
            rowEl: tr,
            deleteUrl: `/v1/admin/delete-passenger/${p.id}`,
            matchFn: it => String(it.id) === String(p.id)
          });
        });
        td5.appendChild(del);
        tr.appendChild(td1); tr.appendChild(td2); tr.appendChild(td3); tr.appendChild(td4); tr.appendChild(td5);
        return tr;
      }

      function rideRow(r) {
        const tr = document.createElement("tr");
        const td1 = document.createElement("td"); td1.textContent = r.driverName || "(N/A)";
        const td2 = document.createElement("td"); td2.textContent = `${r.startLocation || 'N/A'} to ${r.endLocation || 'N/A'}`;
        const stops = (r.pickupLocations || "").split(";").filter(Boolean).join(", ") || "None";
        const td3 = document.createElement("td"); td3.textContent = stops;
        const td4 = document.createElement("td"); td4.textContent = `${r.vehicleModel || ''} ${r.vehiclePlate ? `(${r.vehiclePlate})` : ''}`;
        const td5 = document.createElement("td"); td5.textContent = formatDate(r.departureTime);
        const td6 = document.createElement("td"); td6.textContent = r.availableSeats ?? "N/A";
        const td7 = document.createElement("td"); td7.textContent = r.status || "Unknown";
        tr.appendChild(td1); tr.appendChild(td2); tr.appendChild(td3); tr.appendChild(td4); tr.appendChild(td5); tr.appendChild(td6); tr.appendChild(td7);
        return tr;
      }

      function bookingRow(b) {
        const tr = document.createElement("tr");
        const td1 = document.createElement("td"); td1.textContent = b.passengerName || "(N/A)";
        const td2 = document.createElement("td"); td2.textContent = b.driverName || "(N/A)";
        const td3 = document.createElement("td"); td3.textContent = `${b.startLocation || 'N/A'} to ${b.endLocation || 'N/A'}`;
        const td4 = document.createElement("td"); td4.textContent = `${b.bookedPickupPoint || 'N/A'} -> ${b.bookedDropPoint || 'N/A'}`;
        const td5 = document.createElement("td"); td5.textContent = b.bookingStatus || "Unknown";
        const td6 = document.createElement("td");
        const del = document.createElement("button"); del.className="danger"; del.textContent="Delete";
        del.addEventListener("click", async ()=> {
          const ok = await Swal.fire({ title:`Delete Booking`, text:`Delete booking for ${b.passengerName}?`, icon:"warning", showCancelButton:true, confirmButtonText:"Yes, delete" });
          if (!ok.isConfirmed) return;
          scheduleDeleteWithUndo({
            viewKey: "bookings",
            niceType: "Booking",
            id: String(b.id),
            rowEl: tr,
            deleteUrl: `/v1/admin/delete-booking/${b.id}`, // adjust backend endpoint if different
            matchFn: it => String(it.id) === String(b.id)
          });
        });
        td6.appendChild(del);
        tr.appendChild(td1); tr.appendChild(td2); tr.appendChild(td3); tr.appendChild(td4); tr.appendChild(td5); tr.appendChild(td6);
        return tr;
      }

      // Templates mapping
      const templates = {
        overview: async () => {
          setSubtitle("Overview");
          const wrapper = document.createElement("div");
          const statsCard = document.createElement("div"); statsCard.className="card";
          statsCard.innerHTML = `
            <h3>Platform Summary</h3>
            <div class="grid" id="statsGrid">
              <div class="card"><div class="muted">Admins</div><div id="stat-admins" style="font-weight:800;font-size:22px">-</div></div>
              <div class="card"><div class="muted">Drivers</div><div id="stat-drivers" style="font-weight:800;font-size:22px">-</div></div>
              <div class="card"><div class="muted">Passengers</div><div id="stat-passengers" style="font-weight:800;font-size:22px">-</div></div>
              <div class="card"><div class="muted">Rides</div><div id="stat-rides" style="font-weight:800;font-size:22px">-</div></div>
              <div class="card"><div class="muted">Bookings</div><div id="stat-bookings" style="font-weight:800;font-size:22px">-</div></div>
            </div>`;
          wrapper.appendChild(statsCard);
          (async ()=> {
            try {
              const stats = await apiFetch("/v1/admin/stats");
              if (stats) {
                document.getElementById("stat-admins").textContent = stats?.totalAdmins ?? store.admins.all.length ?? "0";
                document.getElementById("stat-drivers").textContent = stats?.totalDrivers ?? store.drivers.all.length ?? "0";
                document.getElementById("stat-passengers").textContent = stats?.totalPassengers ?? store.passengers.all.length ?? "0";
                document.getElementById("stat-rides").textContent = stats?.totalRides ?? store.rides.all.length ?? "0";
                document.getElementById("stat-bookings").textContent = stats?.totalBookings ?? store.bookings.all.length ?? "0";
              }
            } catch (e) { console.warn("stats fetch", e); }
          })();
          return wrapper;
        },

        admins: async () => {
          return renderList({
            viewKey: "admins",
            title: "Admins",
            cols: ["Fullname","Email","Department","Actions"],
            fetcherPath: "/v1/admin/all",
            renderRow: adminRow
          });
        },

        drivers: async () => {
          return renderList({
            viewKey: "drivers",
            title: "Drivers",
            cols: ["Fullname","Username","Vehicle Plate","Registered","Actions"],
            fetcherPath: "/v1/admin/all-drivers",
            renderRow: driverRow
          });
        },

        passengers: async () => {
          return renderList({
            viewKey: "passengers",
            title: "Passengers",
            cols: ["Fullname","Username","Contact","Age","Actions"],
            fetcherPath: "/v1/admin/all-passengers",
            renderRow: passengerRow
          });
        },

        rides: async () => {
          return renderList({
            viewKey: "rides",
            title: "Rides",
            cols: ["Driver","From → To","Stops","Vehicle","Departure","Seats","Status"],
            fetcherPath: "/v1/admin/all-rides",
            renderRow: rideRow,
            canDelete: false
          });
        },

        bookings: async () => {
          return renderList({
            viewKey: "bookings",
            title: "Bookings",
            cols: ["Passenger","Driver","Route","Stops","Status","Actions"],
            fetcherPath: "/v1/admin/all-bookings",
            renderRow: bookingRow
          });
        },

        settings: async () => {
          setSubtitle("Settings");
          const wrapper = document.createElement("div"); wrapper.className="card";
          wrapper.innerHTML = `
            <h3>Platform Settings</h3>
            <div style="display:flex;gap:12px;flex-direction:column;">
              <label><input id="maintenanceToggle" type="checkbox"> Maintenance mode</label>
              <label>Support email: <input id="supportEmail" type="email" value="support@smartrideshare.com" style="margin-left:8px;padding:6px;border-radius:6px;border:1px solid #eaeaea"></label>
              <div><button id="saveSettings" class="btn-sm">Save Settings</button></div>
            </div>`;
          setTimeout(()=> {
            const btn = wrapper.querySelector("#saveSettings");
            if (btn) btn.addEventListener("click", async ()=> {
              const maintenance = document.getElementById("maintenanceToggle").checked;
              const email = document.getElementById("supportEmail").value;
              try {
                await apiFetch("/v1/admin/save-settings", { method:"POST", body: JSON.stringify({ maintenance, supportEmail: email }) });
                Swal.fire("Saved","Settings saved.","success");
              } catch (err) { console.error(err); Swal.fire("Error","Save failed.","error"); }
            });
          }, 120);
          return wrapper;
        }
      };

      function renderList({ viewKey, title, cols, fetcherPath, renderRow, canDelete = true, deleteEndpointResolver }) {
        setSubtitle(title);
        const { container, tbody } = createTableSkeleton(cols, viewKey + "-table");
        const controls = document.createElement("div"); controls.className = "search-row";
        const searchInput = document.createElement("input"); searchInput.placeholder = `Search ${title.toLowerCase()}...`;
        searchInput.value = store[viewKey].q || "";
        const limitSelect = document.createElement("select");
        [5,10,15,20,50].forEach(n => { const o=document.createElement("option"); o.value=n; o.textContent = `${n}/page`; limitSelect.appendChild(o); });
        limitSelect.value = store[viewKey].limit || getLimitFor(viewKey);
        const refreshBtn = document.createElement("button"); refreshBtn.className="btn-sm"; refreshBtn.textContent="Refresh";
        controls.appendChild(searchInput); controls.appendChild(limitSelect); controls.appendChild(refreshBtn);
        container.insertBefore(controls, container.firstChild);

        const pager = document.createElement("div"); pager.className="pagination";
        container.appendChild(pager);

        async function loadAllAndRender(force=false) {
          try {
            if (!store[viewKey].all.length || force) {
              loadingRow(tbody, cols.length);
              const data = await apiFetch(fetcherPath);
              if (!Array.isArray(data)) {
                if (data && Array.isArray(data.items)) store[viewKey].all = data.items.slice();
                else store[viewKey].all = [];
              } else {
                store[viewKey].all = data.slice();
              }
            }
            applyFilterAndReset(viewKey);
            renderPage();
          } catch (err) {
            console.error("Load error for", viewKey, err);
            tbody.innerHTML = `<tr><td colspan="${cols.length}" class="center muted">Failed to load ${title.toLowerCase()}</td></tr>`;
          }
        }

        function renderPage() {
          const { items, total, totalPages, page, limit } = pageSlice(viewKey);
          tbody.innerHTML = "";
          if (!items.length) {
            emptyRow(tbody, total ? "No results for current search" : `No ${title.toLowerCase()} found`, cols.length);
          } else {
            const frag = document.createDocumentFragment();
            items.forEach(it => {
              const tr = renderRow(it, canDelete, deleteEndpointResolver);
              frag.appendChild(tr);
            });
            tbody.appendChild(frag);
          }
          renderPager(pager, viewKey, renderPage);
        }

        let timer = null;
        searchInput.addEventListener("input", ()=> {
          clearTimeout(timer);
          timer = setTimeout(()=> {
            store[viewKey].q = searchInput.value || "";
            applyFilterAndReset(viewKey);
            store[viewKey].page = 1;
            renderPage();
          }, 500);
        });

        limitSelect.addEventListener("change", ()=> {
          const newLimit = Number(limitSelect.value);
          store[viewKey].limit = newLimit;
          setLimitFor(viewKey, newLimit);
          store[viewKey].page = 1;
          renderPage();
        });

        refreshBtn.addEventListener("click", ()=> loadAllAndRender(true));
        loadAllAndRender();
        return container;
      }

      async function render(view) {
        view = view || (location.hash.replace("#","") || "overview");
        navLinks.forEach(a => a.classList.toggle("active", a.dataset.view === view));
        viewArea.innerHTML = "";
        const comp = templates[view] || templates.overview;
        try {
          const node = await comp();
          viewArea.appendChild(node);
        } catch (err) {
          console.error("Render error", err);
          const errDiv = document.createElement("div"); errDiv.className="card"; errDiv.textContent="Error loading view.";
          viewArea.appendChild(errDiv);
        }
      }
      function handleRouting() {
        const hash = location.hash.replace("#","") || "overview";
        render(hash);
      }
      window.addEventListener("hashchange", handleRouting);
      if (!location.hash) history.replaceState({}, "", "#overview");
      handleRouting();

      // Logout
      logoutButton.addEventListener("click", async (e) => {
        e.preventDefault();
        const confirmation = await Swal.fire({ title:"Logout", text:"Are you sure you want to logout?", icon:"question", showCancelButton:true, confirmButtonText:"Yes, logout" });
        if (!confirmation.isConfirmed) return;
        Swal.fire({ title:"Logging out...", allowOutsideClick:false, didOpen: () => Swal.showLoading() });
        let u = username, r = role;
        try {
          if ((!u || !r) && sessionStorage.getItem("smartRideUser")) {
            const stored = JSON.parse(sessionStorage.getItem("smartRideUser"));
            if (!u && stored.username) u = stored.username;
            if (!r && stored.role) r = stored.role;
          }
        } catch (err) { console.warn("session parse", err); }
        if (r && typeof r === "string") r = r.toUpperCase();
        const logoutBody = { username: u || "", role: r || "" };
        try {
          await apiFetch("/v1/auth/logout", { method: "POST", body: JSON.stringify(logoutBody) }, 10000);
          try { sessionStorage.removeItem("smartRideUser"); } catch (e) {}
          Swal.close(); Swal.fire({ toast:true, position:"top-end", icon:"success", title:"Logged out", timer:1200, showConfirmButton:false }).then(()=>{ window.location.href = "login.html"; });
        } catch (err) {
          console.error("Logout API error", err);
          try { sessionStorage.removeItem("smartRideUser"); } catch (e) {}
          Swal.close();
          Swal.fire({ title:"Logout Error", text:"Could not notify server, but you will be logged out locally.", icon:"warning", confirmButtonText:"OK" }).then(()=>{ window.location.href = "login.html"; });
        }
      });

      // Reset password redirect
      resetPasswordBtn.addEventListener("click", (e) => {
        e.preventDefault();
        let u = username, r = role;
        try {
          if ((!u || !r) && sessionStorage.getItem("smartRideUser")) {
            const stored = JSON.parse(sessionStorage.getItem("smartRideUser"));
            if (!u && stored.username) u = stored.username;
            if (!r && stored.role) r = stored.role;
          }
        } catch(e){ console.warn(e); }
        if (!u || !r) { Swal.fire("Missing Info","Please log in again.","error").then(()=>{ window.location.href="login.html"; }); return; }
        const q = new URLSearchParams({ username: u, role: String(r).toUpperCase() });
        window.location.href = "reset-password.html?" + q.toString();
      });

      // keyboard shortcuts
      document.addEventListener("keydown", (e) => {
        if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === "k") {
          e.preventDefault();
          const search = document.querySelector(".card .search-row input");
          if (search) search.focus();
        }
        if (e.altKey && (e.key === "ArrowRight" || e.key === "ArrowLeft")) {
          const active = document.querySelector(".nav .active")?.dataset?.view;
          if (!active) return;
          const pager = document.querySelector(".card .pagination");
          if (!pager) return;
          const nextBtn = Array.from(pager.querySelectorAll(".page-btn")).find(b => b.textContent === (e.key === "ArrowRight" ? "Next" : "Prev"));
          if (nextBtn && !nextBtn.disabled) nextBtn.click();
        }
      });

    }); // DOMContentLoaded
</script>
</body>
</html>
